
夏炘航
gold15480
6.7 卷积层和池化层的反向传播的实现
实验总用时：00:00:00
nav
第2关：实现池化层的反向传播
300
学习内容
参考答案
记录
评论
任务描述
相关知识
池化层的反向传播
池化层反向传播的实现
编程要求
测试说明
任务描述
本关任务：实现池化层的反向传播。

相关知识
为了完成本关任务，你需要掌握：

池化层的反向传播；
池化层反向传播的实现。
本实训内容可参考《深度学习入门——基于 Python 的理论与实现》一书中第7章的内容。

池化层的反向传播
在之前的实训中，我们学习了池化层的前向传播，也知道无论在原理上还是在实现上池化层的前向传播与卷积层的前向传播都有很强的相似性。二者在反向传播上依然如此，所有的计算都是以窗口为处理单位。

对于平均值池化，反向传播非常简单，只要把对应输出位置的梯度平均放回窗口内的每个输入位置即可。对于最大值池化，如我们之前学习的 max 函数存在不可导点，因此我们按照之前 ReLU 的方法，使用次梯度，即：在每个窗口中，将输出位置的梯度放回前向传播时最大值对应的输入位置。下图展示了最大值池化反向传播的过程。



图1
图1 最大值池化的前向和反向传播
池化层反向传播的实现
在实现池化层的前向传播时，我们采用了与实现卷积层时相似的技巧，即先用 im2col 操作，将输入特征图转化成一个矩阵，每个窗口内的数据都对应到矩阵的每一行，这样，窗口内的平均值操作或者最大值操作就变成矩阵的行操作，从而能够利用 numpy 进行高效的操作。因此，在进行反向传播时，也与卷积层相似，再对变换后的矩阵在平均值或最大值反向传播之后，再用 col2im 操作还原为与前向传播时输入特征图相同的形状。

实训拓展了在之前的实训定义的MaxPool类，实训已经给出了forward(x)的实现，并针对反向传播的需要对其进行了一定的修改。你需要实现该类的反向传播函数backward(dout)，dout是损失函数相对于全连接层输出的梯度，是一个形状为(B,C,H,W)的numpy.ndarray。在前向传播时，输入特征图和最大值对应的索引分别记录在了self.x和self.arg_max中。实训已经提供了一个 col2im 的实现，请参考上一关的介绍。

编程要求
根据提示，在右侧编辑器 Begin 和 End 之间补充代码，实现上述池化层的反向传播。

测试说明
平台会对你编写的代码进行测试，测试方法为：平台会随机产生输入x和输出梯度dout，然后根据你的实现代码，创建一个MaxPool类的实例，然后利用该实例先进行前向传播计算，再进行反向传播计算。你的答案将并与标准答案进行比较。因为浮点数的计算可能会有误差，因此只要你的答案与标准答案之间的误差不超过10 
−5
 即可。

样例输入：

x:
[[[[0.79 0.36 0.41 0.16]
   [0.94 0.56 0.26 0.89]
   [0.82 0.5  0.81 0.47]
   [0.95 0.99 0.38 0.94]]
  [[0.46 0.74 0.32 0.22]
   [0.18 0.05 0.98 0.39]
   [0.81 0.9  0.5  0.57]
   [0.16 0.18 0.73 0.06]]]
 [[[0.51 0.48 0.8  0.57]
   [0.64 0.05 0.64 0.28]
   [0.01 0.65 0.03 0.21]
   [0.24 0.3  0.72 0.89]]
  [[0.14 0.43 0.98 0.6 ]
   [0.79 0.42 0.42 0.39]
   [0.04 0.29 0.55 0.32]
   [0.38 0.26 0.39 0.97]]]]
dout:
[[[[0.41 0.71]
   [0.28 0.74]]
  [[0.39 0.43]
   [0.58 0.25]]]
 [[[0.07 0.55]
   [0.4  0.15]]
  [[0.42 0.83]
   [0.59 0.38]]]]
则对应的输入特征图的梯度为：

dx:
[[[[0.   0.   0.   0.  ]
   [0.41 0.   0.   0.71]
   [0.   0.   0.   0.  ]
   [0.   0.28 0.   0.74]]
  [[0.   0.39 0.   0.  ]
   [0.   0.   0.43 0.  ]
   [0.   0.58 0.   0.  ]
   [0.   0.   0.25 0.  ]]]
 [[[0.   0.   0.55 0.  ]
   [0.07 0.   0.   0.  ]
   [0.   0.4  0.   0.  ]
   [0.   0.   0.   0.15]]
  [[0.   0.   0.83 0.  ]
   [0.42 0.   0.   0.  ]
   [0.   0.   0.   0.  ]
   [0.59 0.   0.   0.38]]]]
开始你的任务吧，祝你成功！

说点什么
resize-icon
12345678910111213141516171819202122
import numpy as np
from utils import im2col, col2im


class MaxPool:
    def __init__(self, pool_h, pool_w, stride=1, pad=0):
        r'''
        池化层的初始化

        Parameter:

测试结果
测试集1
本关最大执行时间：20秒
上一关
run
评测
