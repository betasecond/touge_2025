
夏炘航
gold15480
6.7 卷积层和池化层的反向传播的实现
实验总用时：00:00:13
nav
第1关：实现卷积层的反向传播
300
学习内容
参考答案
记录
评论
任务描述
相关知识
卷积层的反向传播
卷积层反向传播的实现
编程要求
测试说明
任务描述
本关任务：实现卷积层的反向传播。

相关知识
为了完成本关任务，你需要掌握：卷积层的反向传播。

本实训内容可参考《深度学习入门——基于 Python 的理论与实现》一书中第7章的内容。

卷积层的反向传播
在之前的实训中，我们学习了卷积层的前向传播。我们知道，卷积层的前向传播通常先通过 im2col 操作将输入特征图转化成一个矩阵，其中矩阵的每一行对应于输入特征图在一个卷积窗口的所有通道内的数据，这样，卷积操作就被转化成了矩阵乘法。忽略掉偏置的计算（因为偏置的计算非常简单），卷积计算可以用下面的公式表示：

y
^
​
 = 
x
^
 × 
W
^
 

这里， 
x
^
 是输入x经过 im2col 计算后的结果。因为卷积层的权重W的形状通常是(C 
′
 ,C,K 
h
​
 ,K 
w
​
 )，为了匹配上面矩阵乘法的形式，需要通过 reshape 和 transpose 操作将W转化为(C⋅K 
h
​
 ⋅K 
w
​
 ,C 
′
 )的形状，这里记这个矩阵为 
W
^
 。得到的结果 
y
^
​
 的形状是(B⋅H 
′
 ⋅W 
′
 ,C 
′
 )，通过 reshape 和 transpose 操作将其变换成(B,C 
′
 ,H 
′
 ,W 
′
 )就是我们想要的结果了。

对于这个形式，你是否感觉有一点熟悉呢？没错，这与我们之前学习的全连接层的计算形式如出一辙，套用全连接层的反向传播公式：

∂ 
W
^
 
∂l
​
 
∂ 
x
^
 
∂l
​
 
​
  
= 
∂ 
y
^
​
 
∂l
​
 ⋅ 
∂ 
W
^
 
∂ 
y
^
​
 
​
 = 
x
^
 ×( 
∂ 
y
^
​
 
∂l
​
 ) 
T
 
= 
∂ 
y
^
​
 
∂l
​
 ⋅ 
∂ 
x
^
 
∂ 
y
^
​
 
​
 = 
W
^
 × 
∂ 
y
^
​
 
∂l
​
 
​
 

最后，我们需要做的就是把∂l/∂ 
x
^
 变换为∂l/∂x，同时把把∂l/∂ 
W
^
 变换为∂l/∂W。对于后者，只要通过 transpose 和 reshape 操作还原为原来的形状即可。对于前者，我们需要通过 im2col 的逆运算——col2im——来降其转换为∂l/∂x。

卷积层反向传播的实现
实训拓展了在之前的实训定义的Convolution类，实训已经给出了forward(x)的实现，并针对反向传播的需要对其进行了一定的修改。你需要实现该类的反向传播函数backward(dout)，dout是损失函数相对卷积层输出的梯度，即之前公式中的 
∂y
∂l
​
 ，是一个形状为(B,C 
′
 ,H 
′
 ,W 
′
 )的numpy.ndarray。实训已经提供了一个col2im的实现，其可以将一个(B×H 
′
 ×W 
′
 ,C×K 
h
​
 ×K 
w
​
 )的矩阵转化成(B,C,H,W)的特征图。

实训提供的col2im函数的定义如下：col2im(col, input_shape, filter_h, filter_w, stride=1, pad=0)，对应参数的含义分别为：

col：变换后的矩阵；
input_shape：输入特征图的形状；
filter_h和filter_w：池化窗口的宽和高；
stride：池化的步长；
pad：池化的填充。
编程要求
根据提示，在右侧编辑器 Begin 和 End 之间补充代码，实现上述卷积层的前向传播。

测试说明
平台会对你编写的代码进行测试，测试方法为：平台会随机产生输入x、权重W、偏置b和输出梯度dout，然后根据你的实现代码，创建一个Convolution类的实例，然后利用该实例先进行前向传播计算，再进行反向传播计算。你的答案将并与标准答案进行比较。因为浮点数的计算可能会有误差，因此只要你的答案与标准答案之间的误差不超过10 
−5
 即可。

样例输入：

x:
[[[[0.11 0.65 0.08 0.28 0.77]
   [0.12 0.29 0.77 0.58 0.11]
   [0.44 0.43 0.4  0.28 0.87]
   [0.52 0.78 0.99 0.58 0.13]
   [0.46 0.31 0.9  0.19 0.3 ]]
  [[0.12 0.65 0.58 0.44 0.9 ]
   [0.23 0.34 0.96 0.94 0.37]
   [0.63 0.17 0.61 0.22 0.98]
   [0.91 0.32 0.78 0.61 0.42]
   [0.21 0.01 0.9  0.06 0.2 ]]]
 [[[0.79 0.36 0.39 0.6  0.12]
   [0.84 0.62 0.32 0.84 0.69]
   [0.34 0.21 0.03 0.17 0.22]
   [0.6  0.19 0.4  1.   0.93]
   [0.46 0.54 0.62 0.8  0.81]]
  [[0.12 0.7  0.88 0.53 0.79]
   [0.36 0.14 0.87 0.99 0.27]
   [0.35 0.87 0.25 0.57 0.3 ]
   [0.92 0.23 0.84 0.72 0.9 ]
   [0.05 0.91 0.61 0.23 0.56]]]]
W:
[[[[-0.77  0.09 -0.46]
   [ 0.42  0.89  0.97]
   [ 0.41  0.52  2.57]]
  [[-0.75  0.75 -0.38]
   [-0.78 -1.72  0.99]
   [ 1.24 -0.68 -1.2 ]]]
 [[[-0.44  0.3  -0.01]
   [-0.03 -0.75  1.33]
   [-0.13  1.63  0.02]]
  [[-1.11 -1.18 -1.46]
   [ 0.76 -1.01 -1.38]
   [ 0.88  0.43 -1.41]]]]
b:
[0.94 1.15]
dout:
[[[[0.12 0.09 0.12 0.87 0.02]
   [0.21 0.26 0.51 0.61 0.34]
   [0.04 0.59 0.69 0.45 0.06]
   [0.14 0.56 0.18 0.17 0.47]
   [0.69 0.18 0.73 0.4  0.79]]
  [[0.8  0.62 0.72 0.45 0.96]
   [0.34 0.7  0.15 0.44 0.39]
   [0.2  0.97 0.8  0.36 0.93]
   [0.93 0.3  0.63 0.13 0.12]
   [0.94 0.77 0.18 0.78 0.15]]]
 [[[0.35 0.72 0.24 0.56 0.09]
   [0.3  0.35 0.56 0.99 0.73]
   [0.98 0.96 0.23 0.9  0.11]
   [0.13 0.84 0.74 0.83 0.78]
   [0.12 0.89 0.44 0.1  0.05]]
  [[0.43 0.14 0.4  0.3  0.26]
   [0.3  0.19 0.48 0.93 0.53]
   [0.06 0.7  0.6  0.6  0.45]
   [0.45 0.34 0.53 0.78 0.98]
   [0.09 0.4  0.66 0.48 0.97]]]]
stride: 1
pad: 1
则对应的梯度为：

dW:
[[[[ 7.13  8.73  7.06]
   [ 8.88 10.84  9.14]
   [ 7.69  9.52  7.76]]
  [[ 9.1  10.96  9.22]
   [10.08 12.4  10.84]
   [ 8.37  9.58  8.4 ]]]
 [[[ 7.85  9.8   7.89]
   [10.09 13.15 10.29]
   [ 8.24 10.3   8.54]]
  [[ 9.9  12.03  9.94]
   [11.2  14.32 10.46]
   [ 9.18 10.2   8.73]]]]
db:
[22.28 25.81]
dx:
[[[[-0.86  0.5   0.13  1.01  0.6 ]
   [ 0.53  1.35  3.06  1.8   5.08]
   [ 0.51  2.03  3.2   3.85  2.66]
   [-0.02  3.16  3.41  3.03  3.3 ]
   [ 1.74  2.95  4.48  2.    2.9 ]]
  [[-1.83 -3.07 -3.9  -3.27 -1.84]
   [-1.18 -4.4  -3.96 -4.45 -4.01]
   [-0.8  -4.18 -4.8  -2.68 -2.55]
   [-1.33 -3.98 -4.19 -4.52 -2.5 ]
   [-0.43 -3.09 -2.66 -1.98 -2.85]]]
 [[[ 0.05  0.84 -0.12  0.38  0.59]
   [ 0.4   2.04  2.73  2.93  4.09]
   [ 1.32  2.18  3.09  4.05  5.21]
   [ 0.21  5.2   5.26  3.39  5.16]
   [ 1.5   2.46  4.97  4.83  4.2 ]]
  [[-2.09 -2.98 -2.84 -3.86 -2.09]
   [-0.82 -3.19 -4.79 -5.26 -4.81]
   [-2.88 -2.64 -2.45 -5.77 -5.37]
   [-1.04 -4.3  -3.87 -5.76 -6.24]
   [ 0.76 -1.61 -0.85 -0.47 -3.83]]]]
上述结果有四舍五入的误差，你可以忽略。

开始你的任务吧，祝你成功！

说点什么
resize-icon
12345678910111213141516171819202122
import numpy as np
from utils import im2col, col2im


class Convolution:
    def __init__(self, W, b, stride=1, pad=0):
        r'''
        卷积层的初始化

        Parameter:

测试结果
测试集1
本关最大执行时间：20秒
下一关
run
评测
